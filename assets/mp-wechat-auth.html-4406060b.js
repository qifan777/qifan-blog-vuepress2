import{_ as c}from"./plugin-vue_export-helper-c27b6911.js";import{r as a,o as l,c as i,e as n,f as s,d as t,w as u,a as e}from"./app-3576ce15.js";const r={},k=n("h1",{id:"微信小程序认证",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#微信小程序认证","aria-hidden":"true"},"#"),s(" 微信小程序认证")],-1),d=n("h2",{id:"小程序认证模型",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#小程序认证模型","aria-hidden":"true"},"#"),s(" 小程序认证模型")],-1),v=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeChatAuth</span> <span class="token keyword">implements</span> <span class="token class-name">AuthModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="小程序认证策略" tabindex="-1"><a class="header-anchor" href="#小程序认证策略" aria-hidden="true">#</a> 小程序认证策略</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token class-name">IAuthStrategy</span><span class="token punctuation">.</span><span class="token constant">WECHAT</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatAuthStrategyImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IAuthStrategy</span> <span class="token punctuation">{</span>
  <span class="token comment">// 微信小程序工具包</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaService</span> wxMaService<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JSqlClient</span> jSqlClient<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@SneakyThrows</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">SaTokenInfo</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token class-name">AuthModel</span> authModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WeChatAuth</span> weChatAuth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WeChatAuth</span><span class="token punctuation">)</span> authModel<span class="token punctuation">;</span>
    <span class="token comment">// 能解析出openId就已经代表认证成功</span>
    <span class="token class-name">WxMaJscode2SessionResult</span> session <span class="token operator">=</span> wxMaService<span class="token punctuation">.</span><span class="token function">getUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>weChatAuth<span class="token punctuation">.</span><span class="token function">getLoginCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> openid <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getOpenid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserWeChatTable</span> t <span class="token operator">=</span> <span class="token class-name">UserWeChatTable</span><span class="token punctuation">.</span>$<span class="token punctuation">;</span>
    <span class="token class-name">UserWeChat</span> userWechat <span class="token operator">=</span> jSqlClient<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">openId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>openid<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fetchOptional</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">AuthErrorCode</span><span class="token punctuation">.</span><span class="token constant">USER_PERMISSION_UNAUTHENTICATED</span><span class="token punctuation">,</span> <span class="token string">&quot;请绑定手机号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 登录的设备是微信</span>
    <span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>userWechat<span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LoginDevice</span><span class="token punctuation">.</span><span class="token constant">MP_WECHAT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">getTokenInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),m={class:"hint-container info"},h=n("p",{class:"hint-container-title"},"相关信息",-1),b={href:"https://github.com/Wechat-Group/WxJava/tree/develop/spring-boot-starters/wx-java-mp-spring-boot-starter",target:"_blank",rel:"noopener noreferrer"},g=e(`<h2 id="定义api" tabindex="-1"><a class="header-anchor" href="#定义api" aria-hidden="true">#</a> 定义API</h2><p>在<code>AuthController</code>中新增微信小程序认证方式。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wechat&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">SaTokenInfo</span> <span class="token function">authByWecChat</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">WeChatAuth</span> weChatAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authStrategyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">IAuthStrategy</span><span class="token punctuation">.</span><span class="token constant">WECHAT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>weChatAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置小程序" tabindex="-1"><a class="header-anchor" href="#配置小程序" aria-hidden="true">#</a> 配置小程序</h2><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">wx</span><span class="token punctuation">:</span>
  <span class="token key atrule">miniapp</span><span class="token punctuation">:</span>
    <span class="token key atrule">appid</span><span class="token punctuation">:</span> appid <span class="token comment">#你的小程序appid</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> secret <span class="token comment">#你的小程序secret</span>
    <span class="token key atrule">config-storage</span><span class="token punctuation">:</span>
      <span class="token key atrule">http-client-type</span><span class="token punctuation">:</span> HttpClient
      <span class="token key atrule">type</span><span class="token punctuation">:</span> redistemplate
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="自动续签" tabindex="-1"><a class="header-anchor" href="#自动续签" aria-hidden="true">#</a> 自动续签</h2><p>在application.yml中新增sa-token配置</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>  <span class="token comment"># 自动续签</span>
  <span class="token key atrule">auto-renew</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="小程序端" tabindex="-1"><a class="header-anchor" href="#小程序端" aria-hidden="true">#</a> 小程序端</h2><h3 id="小程序登录" tabindex="-1"><a class="header-anchor" href="#小程序登录" aria-hidden="true">#</a> 小程序登录</h3><p>在<code>src/pages/index/index.vue</code>调用登录接口。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">&quot;ts&quot;</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> Taro <span class="token keyword">from</span> <span class="token string">&quot;@tarojs/taro&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> api <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/utils/api-instance&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useHomeStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/stores/home-store&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> RegisterPopup <span class="token keyword">from</span> <span class="token string">&quot;@/components/register-popup/register-popup.vue&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> homeStore <span class="token operator">=</span> <span class="token function">useHomeStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Taro<span class="token punctuation">.</span><span class="token function">useLoad</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Taro<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>loginRes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用微信登录接口</span>
      api<span class="token punctuation">.</span>authController
        <span class="token punctuation">.</span><span class="token function">authByWecChat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          body<span class="token operator">:</span> <span class="token punctuation">{</span>
            loginCode<span class="token operator">:</span> loginRes<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 存储token，下次发起请求时携带</span>
          Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          homeStore<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>register<span class="token operator">-</span>popup<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>register<span class="token operator">-</span>popup<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>style scoped lang<span class="token operator">=</span><span class="token string">&quot;scss&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,12);function f(y,w){const p=a("RouterLink"),o=a("ExternalLinkIcon");return l(),i("div",null,[k,d,n("p",null,[s("请参考"),t(p,{to:"/project/qifan-mall/login/phone-password-auth.md/#%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0"},{default:u(()=>[s("手机号密码认证")]),_:1})]),v,n("div",m,[h,n("p",null,[n("a",b,[s("WxMaService"),t(o)]),s("这个包中实现了小程序的服务端API，并且提供了starter只需配置好APPID和SECRET即可使用。")])]),g])}const x=c(r,[["render",f],["__file","mp-wechat-auth.html.vue"]]);export{x as default};
